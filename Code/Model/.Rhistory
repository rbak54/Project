b0
0.256
g
0.078
shrunk_data<-as.data.frame(matrix(nrow=8,ncol=6))
colnames(shrunk_data)<-c("Temp","Hum","Half","sd_Half","b","sd_b")
shrunk_data$Temp<-c(24,24,24,24,28,35,35,35)
shrunk_data$Hum<-c(20,40,60,80,40,20,40,60)
shrunk_data$Half<-c(15.33,11.52,9.15 ,8.33 ,6.11,7.33 ,7.52,  2.26)/24
shrunk_data$sd_Half<-c(2.75,1.72,3.39,1.80,3.02,1.33,1.22,1.42)/24
shrunk_data$b<-log(1/2)/shrunk_data$Half
shrunk_data$st_b<-log(1/2)/shrunk_data$sd_Half
plot(shrunk_data$Temp,shrunk_data$b)
plot(shrunk_data$Hum,shrunk_data$b)
Temps<-seq(-10,40,length.out = 1000)
Temp_Model<-nlsLM(b~b0*exp(Temp*g),data=shrunk_data,start = list(g=0,b0=0))
g<-summary(Temp_Model)$coefficients[1,1]
b0<-summary(Temp_Model)$coefficients[2,1]
plot(Temps,b0*exp(g*Temps),"s")
points(shrunk_data$Temp,shrunk_data$b)
shrunk_data_repeats
#result of all this is that equation for how b responds to temp is
b0
0.256
g
0.078
#data and functions
source("modelling_functions.R")
require("tidyverse")
require("ggplot2")
source("latincube.R")
source("data_sorting.R")
source("gazeteer.R")
#integration  N changing
population_deyle<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
latlong=read.csv("../../Data/latlong/latlong_sel_short.csv")
pop<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
integration_general<-function(parms,sims,time){
Y<-make_lhs(n=sims,parms = parms)
write.csv(Y,"../../Data/latincube.csv")
extra_cols<-9
model_means=matrix(ncol =7)
names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp","combination")
parms_temp<-parms
parms_temp[["sigma"]]<-NA
parms_temp[["h"]]<-NA
parms_temp[["mu"]]<-NA
parms_temp[["f"]]<-NA
parms_temp[["N"]]<-NA
for (combination in 1:nrow(Y)){
parms_temp[["sigma"]]<-Y$sigma[combination]
parms_temp[["h"]]<-Y$h[combination]
parms_temp[["mu"]]<-Y$mu[combination]
parms_temp[["f"]]<-Y$f[combination]
for (location_index in 1:nrow(data_wider_means_summ)){
parms_temp[["N"]]=population_deyle[location_index,3]
start = c(S = (1-1e-4)*parms_temp[["N"]],
E = 0.00*parms_temp[["N"]],
I =(1e-4)*parms_temp[["N"]],
R = 0*parms_temp[["N"]])
if(parms[["climate_label"]]=="Temperature"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],length.out=5)
for (i in peak_contact_seq){
#difference between temperature where contact rate is highest and lowest temperature in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low temp
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakT"]*7,range_C=c(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
temp = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],data_wider_means_summ[location_index,"peakT"],mismatch,NA,NA,NA,combination)),nrow=nrow(temp),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","temperature","R0","week","combination")
temp_extra[,"temperature"]<-Climate_Time_Function(time = time[1:nrow(temp)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(temp)),"temperature"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((temp[,"time"])/365)
day<-(temp[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
temp<-cbind(temp,temp_extra)
temp<-as_tibble(temp)
#model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I/(S+E+I+R)),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(temp)
#graphics.off()
}
}
if(parms[["climate_label"]]=="RH"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],length.out=5)
for (i in peak_contact_seq){
#difference between relative_humidity where contact rate is highest and lowest relative_humidity in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low RH
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakRH"]*7,range_C=c(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
RH = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],data_wider_means_summ[location_index,"peakRH"],mismatch,NA,NA,NA,combination)),nrow=nrow(RH),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","relative_humidity","R0","week","combination")
temp_extra[,"relative_humidity"]<-Climate_Time_Function(time = time[1:nrow(RH)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(RH)),"relative_humidity"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((RH[,"time"])/365)
day<-(RH[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
RH<-cbind(RH,temp_extra)
RH<-as_tibble(RH)
model_means_temp<- RH %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meanRH=mean(relative_humidity),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(RH)
#graphics.off()
}
}
}
}
model_means<-model_means[-1,]
return(model_means)
}
std <- function(x) sd(x)/sqrt(length(x))
parms = list( mu = 2.06e-5, sigma = 0.68 ,p = 0.001, gamma =0.25,f=0.1,
N = NA, nu = 5.07e-5, h=0.25 / 24 ,epsilon= 0.05, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.0784,q0=-0.2557,Climate_Variables=NA)
time = seq(1,365*10, by=1)
model_means<-integration_general(parms,sims,time)
#data and functions
source("modelling_functions.R")
require("tidyverse")
require("ggplot2")
source("latincube.R")
source("data_sorting.R")
source("gazeteer.R")
#integration  N changing
population_deyle<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
setwd("~/Documents/Project/Code/Model")
#data and functions
source("modelling_functions.R")
require("tidyverse")
require("ggplot2")
source("latincube.R")
source("data_sorting.R")
source("gazeteer.R")
#integration  N changing
population_deyle<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
latlong=read.csv("../../Data/latlong/latlong_sel_short.csv")
pop<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
integration_general<-function(parms,sims,time){
Y<-make_lhs(n=sims,parms = parms)
write.csv(Y,"../../Data/latincube.csv")
extra_cols<-9
model_means=matrix(ncol =7)
names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp","combination")
parms_temp<-parms
parms_temp[["sigma"]]<-NA
parms_temp[["h"]]<-NA
parms_temp[["mu"]]<-NA
parms_temp[["f"]]<-NA
parms_temp[["N"]]<-NA
for (combination in 1:nrow(Y)){
parms_temp[["sigma"]]<-Y$sigma[combination]
parms_temp[["h"]]<-Y$h[combination]
parms_temp[["mu"]]<-Y$mu[combination]
parms_temp[["f"]]<-Y$f[combination]
for (location_index in 1:nrow(data_wider_means_summ)){
parms_temp[["N"]]=population_deyle[location_index,3]
start = c(S = (1-1e-4)*parms_temp[["N"]],
E = 0.00*parms_temp[["N"]],
I =(1e-4)*parms_temp[["N"]],
R = 0*parms_temp[["N"]])
if(parms[["climate_label"]]=="Temperature"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],length.out=5)
for (i in peak_contact_seq){
#difference between temperature where contact rate is highest and lowest temperature in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low temp
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakT"]*7,range_C=c(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
temp = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],data_wider_means_summ[location_index,"peakT"],mismatch,NA,NA,NA,combination)),nrow=nrow(temp),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","temperature","R0","week","combination")
temp_extra[,"temperature"]<-Climate_Time_Function(time = time[1:nrow(temp)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(temp)),"temperature"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((temp[,"time"])/365)
day<-(temp[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
temp<-cbind(temp,temp_extra)
temp<-as_tibble(temp)
#model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I/(S+E+I+R)),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(temp)
#graphics.off()
}
}
if(parms[["climate_label"]]=="RH"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],length.out=5)
for (i in peak_contact_seq){
#difference between relative_humidity where contact rate is highest and lowest relative_humidity in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low RH
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakRH"]*7,range_C=c(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
RH = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],data_wider_means_summ[location_index,"peakRH"],mismatch,NA,NA,NA,combination)),nrow=nrow(RH),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","relative_humidity","R0","week","combination")
temp_extra[,"relative_humidity"]<-Climate_Time_Function(time = time[1:nrow(RH)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(RH)),"relative_humidity"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((RH[,"time"])/365)
day<-(RH[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
RH<-cbind(RH,temp_extra)
RH<-as_tibble(RH)
model_means_temp<- RH %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meanRH=mean(relative_humidity),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(RH)
#graphics.off()
}
}
}
}
model_means<-model_means[-1,]
return(model_means)
}
std <- function(x) sd(x)/sqrt(length(x))
parms = list( mu = 2.06e-5, sigma = 0.68 ,p = 0.001, gamma =0.25,f=0.1,
N = NA, nu = 5.07e-5, h=0.25 / 24 ,epsilon= 0.05, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.0784,q0=-0.2557,Climate_Variables=NA)
time = seq(1,365*10, by=1)
model_means<-integration_general(parms,sims,time)
parms = list( mu = 2.06e-5, sigma = 0.68 ,p = 0.001, gamma =0.25,f=0.1,
N = NA, nu = 5.07e-5, h=0.25 / 24 ,epsilon= 0.05, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.0784,q0=-0.2557,Climate_Variables=NA)
sims
time = seq(1,365*10, by=1)
sims=1
time = seq(1,365*10, by=1)
model_means<-integration_general(parms,sims,time)
model_means<-integration_general(parms,sims,time)
#data and functions
source("modelling_functions.R")
require("tidyverse")
require("ggplot2")
source("latincube.R")
source("data_sorting.R")
source("gazeteer.R")
#integration  N changing
population_deyle<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
latlong=read.csv("../../Data/latlong/latlong_sel_short.csv")
pop<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
integration_general<-function(parms,sims,time){
Y<-make_lhs(n=sims,parms = parms)
write.csv(Y,"../../Data/latincube.csv")
extra_cols<-9
model_means=matrix(ncol =7)
names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp","combination")
parms_temp<-parms
parms_temp[["sigma"]]<-NA
parms_temp[["h"]]<-NA
parms_temp[["mu"]]<-NA
parms_temp[["f"]]<-NA
parms_temp[["N"]]<-NA
for (combination in 1:nrow(Y)){
parms_temp[["sigma"]]<-Y$sigma[combination]
parms_temp[["h"]]<-Y$h[combination]
parms_temp[["mu"]]<-Y$mu[combination]
parms_temp[["f"]]<-Y$f[combination]
for (location_index in 1:nrow(data_wider_means_summ)){
parms_temp[["N"]]=population_deyle[location_index,3]
start = c(S = (1-1e-4)*parms_temp[["N"]],
E = 0.00*parms_temp[["N"]],
I =(1e-4)*parms_temp[["N"]],
R = 0*parms_temp[["N"]])
if(parms[["climate_label"]]=="Temperature"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],length.out=5)
for (i in peak_contact_seq){
#difference between temperature where contact rate is highest and lowest temperature in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low temp
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakT"]*7,range_C=c(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
temp = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],data_wider_means_summ[location_index,"peakT"],mismatch,NA,NA,NA,combination)),nrow=nrow(temp),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","temperature","R0","week","combination")
temp_extra[,"temperature"]<-Climate_Time_Function(time = time[1:nrow(temp)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(temp)),"temperature"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((temp[,"time"])/365)
day<-(temp[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
temp<-cbind(temp,temp_extra)
temp<-as_tibble(temp)
#model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I/(S+E+I+R)),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(temp)
#graphics.off()
}
}
if(parms[["climate_label"]]=="RH"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],length.out=5)
for (i in peak_contact_seq){
#difference between relative_humidity where contact rate is highest and lowest relative_humidity in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low RH
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakRH"]*7,range_C=c(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
RH = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],data_wider_means_summ[location_index,"peakRH"],mismatch,NA,NA,NA,combination)),nrow=nrow(RH),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","relative_humidity","R0","week","combination")
temp_extra[,"relative_humidity"]<-Climate_Time_Function(time = time[1:nrow(RH)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(RH)),"relative_humidity"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((RH[,"time"])/365)
day<-(RH[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
RH<-cbind(RH,temp_extra)
RH<-as_tibble(RH)
model_means_temp<- RH %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meanRH=mean(relative_humidity),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(RH)
#graphics.off()
}
}
}
}
model_means<-model_means[-1,]
return(model_means)
}
std <- function(x) sd(x)/sqrt(length(x))
parms = list( mu = 2.06e-5, sigma = 0.68 ,p = 0.001, gamma =0.25,f=0.1,
N = NA, nu = 5.07e-5, h=0.25 / 24 ,epsilon= 0.05, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.0784,q0=-0.2557,Climate_Variables=NA)
sims=1
time = seq(1,365*10, by=1)
model_means<-integration_general(parms,sims,time)
setwd("~/Documents/Project/Code/Model")
model_means<-integration_general(parms,sims,time)
#data and functions
source("modelling_functions.R")
require("tidyverse")
require("ggplot2")
source("latincube.R")
source("data_sorting.R")
source("gazeteer.R")
#integration  N changing
population_deyle<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
latlong=read.csv("../../Data/latlong/latlong_sel_short.csv")
pop<-read.csv("../../Data/population/API_SP.POP.TOTL_DS2_en_csv_v2_1217749/populations_sel.csv")
data_wider_means_summ<-read.csv("../../Data/data_wider_means_summ_POP.csv")
data_wider_summ<-read.csv("../../Data/data_wider_summ_POP.csv")
data_wider_means<-read.csv("../../Data/data_wider_means_POP.csv")
flu_things<-read.csv("../../Results/fromfunction/cors/200Temperaturecorrelation_dataframe.csv")
bests<-flu_things %>% group_by(country,mismatch) %>% summarise(mean_corr=mean(corsI))
bests <- bests %>% summarise(best=mismatch[which.max(mean_corr)],.groups="keep")
integration_general<-function(parms,sims,time){
Y<-make_lhs(n=sims,parms = parms)
write.csv(Y,"../../Data/latincube.csv")
extra_cols<-9
model_means=matrix(ncol =7)
names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp","combination")
parms_temp<-parms
parms_temp[["sigma"]]<-NA
parms_temp[["h"]]<-NA
parms_temp[["mu"]]<-NA
parms_temp[["f"]]<-NA
parms_temp[["N"]]<-NA
for (combination in 1:nrow(Y)){
parms_temp[["sigma"]]<-Y$sigma[combination]
parms_temp[["h"]]<-Y$h[combination]
parms_temp[["mu"]]<-Y$mu[combination]
parms_temp[["f"]]<-Y$f[combination]
for (location_index in 1:nrow(data_wider_means_summ)){
parms_temp[["N"]]=population_deyle[location_index,3]
start = c(S = (1-1e-4)*parms_temp[["N"]],
E = 0.00*parms_temp[["N"]],
I =(1e-4)*parms_temp[["N"]],
R = 0*parms_temp[["N"]])
if(parms[["climate_label"]]=="Temperature"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],length.out=5)
mismatch=(peak_contact_seq-data_wider_means_summ[location_index,"minT"])/(data_wider_means_summ[location_index,"maxT"]-data_wider_means_summ[location_index,"minT"])
mismatch<-round(mismatch,2)
flu_mismatch<-bests$best[which(bests$country==data_wider_means_summ$country[location_index])]
i=peak_contact_seq[which(mismatch==flu_mismatch)]
# c(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"])
#difference between temperature where contact rate is highest and lowest temperature in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low temp
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakT"]*7,range_C=c(data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
temp = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
plottime(temp)
graphics.off()
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minT"],data_wider_means_summ[location_index,"maxT"],data_wider_means_summ[location_index,"peakT"],mismatch,NA,NA,NA,combination)),nrow=nrow(temp),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","temperature","R0","week","combination")
temp_extra[,"temperature"]<-Climate_Time_Function(time = time[1:nrow(temp)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(temp)),"temperature"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((temp[,"time"])/365)
day<-(temp[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
temp<-cbind(temp,temp_extra)
temp<-as_tibble(temp)
#model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
model_means_temp<- temp %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I/(S+E+I+R)),meanR0=mean(R0),meantemp=mean(temperature),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meantemp")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(temp)
#graphics.off()
}
if(parms[["climate_label"]]=="RH"){
peak_contact_seq<-seq(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],length.out=5)
mismatch=(peak_contact_seq-data_wider_means_summ[location_index,"minRH"])/(data_wider_means_summ[location_index,"maxRH"]-data_wider_means_summ[location_index,"minRH"])
mismatch<-round(mismatch,2)
flu_mismatch<-bests$best[which(bests$country==data_wider_means_summ$country[location_index])]
i=peak_contact_seq[which(mismatch==flu_mismatch)]
#difference between relative_humidity where contact rate is highest and lowest relative_humidity in range (i.e virus does best survivasl or virus does best contact)
#mismatch= 0 is when contact rate is highest at low RH
parms_temp[["Climate_Variables"]]= list(time_at_peak=data_wider_means_summ[location_index,"peakRH"]*7,range_C=c(data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"]),Max_Climate_cr=i)
mismatch=(i-parms_temp[["Climate_Variables"]][["range_C"]][1])/(parms_temp[["Climate_Variables"]][["range_C"]][2]-parms_temp[["Climate_Variables"]][["range_C"]][1])
#test time<-as.vector(read.csv("../../Results/time.csv"))[,2]
mismatch<-round(mismatch,2)
RH = ode(    y = start,    time = time,    func = SEIR_model,    parms = parms_temp)
png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
plottime(RH)
graphics.off()
temp_extra<-matrix(rep(c(location_index,data_wider_means_summ[location_index,"minRH"],data_wider_means_summ[location_index,"maxRH"],data_wider_means_summ[location_index,"peakRH"],mismatch,NA,NA,NA,combination)),nrow=nrow(RH),ncol=extra_cols,byrow=T)
colnames(temp_extra)<-c("country","lower","upper","peak_week","mismatch","relative_humidity","R0","week","combination")
temp_extra[,"relative_humidity"]<-Climate_Time_Function(time = time[1:nrow(RH)],min=parms_temp[["Climate_Variables"]][["range_C"]][1],max=parms_temp[["Climate_Variables"]][["range_C"]][2],time_at_peak =parms_temp[["Climate_Variables"]][["time_at_peak"]] )
temp_extra[,"R0"]<-find_R0_function(Climate=temp_extra[c(1:nrow(RH)),"relative_humidity"],parms=parms_temp, Climate_Variables_Temp=parms_temp[["Climate_Variables"]], max_R0_Req=F)
year<-ceiling((RH[,"time"])/365)
day<-(RH[,"time"]-(year-1)*365)
temp_extra[,"week"]<-ceiling(day/7)
temp_extra[,"country"]<-location_index
RH<-cbind(RH,temp_extra)
RH<-as_tibble(RH)
model_means_temp<- RH %>% group_by(country,week,mismatch,combination) %>% summarise(meanI=mean(I),meanR0=mean(R0),meanRH=mean(relative_humidity),.groups="drop")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#    names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
model_means<-bind_rows(model_means,model_means_temp)
#names(model_means)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#names(model_means_temp)<-c("country","week","mismatch","meanI","meanR0","meanRH")
#png(paste0("../../Results/Plots/model_series/",data_wider_means_summ[location_index,"country"],gsub("\\.","",mismatch),".png"))
#plottime(RH)
#graphics.off()
}
}
}
model_means<-model_means[-1,]
return(model_means)
}
parms = list( mu = 2.06e-5,sigma = 1/5 ,p = 0.01, gamma =1/21,f=0.1,
N = NA, nu = 5.07e-5, h=0.25/24 ,epsilon= 0.01, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.07841,q0=-0.2557,Climate_Variables=NA)
sims=1
model_means<-integration_general(parms,sims,time)
time = seq(1,365*10, by=1)
parms = list( mu = 2.06e-5,sigma = 1/5 ,p = 0.01, gamma =1/21,f=0.1,
N = NA, nu = 5.07e-5, h=0.25/24 ,epsilon= 0.01, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.07841,q0=-0.2557,Climate_Variables=NA)
sims=1
model_means<-integration_general(parms,sims,time)
parms = list( mu = 2.06e-5,sigma = 1/5 ,p = 0.01, gamma =1/21,f=0.05,
N = NA, nu = 5.07e-5, h=0.25/24 ,epsilon= 0.01, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.07841,q0=-0.2557,Climate_Variables=NA)
sims=1
model_means<-integration_general(parms,sims,time)
parms = list( mu = 2.06e-5,sigma = 1/5 ,p = 0.01, gamma =1/21,f=0.05,
N = NA, nu = 5.07e-5, h=0.25/24 ,epsilon= 0.01, d=4/24,Max_cr=29.97,climate_label="Temperature",
g=0.07841,q0=-0.2557,Climate_Variables=NA)
sims=1
model_means<-integration_general(parms,sims,time)
